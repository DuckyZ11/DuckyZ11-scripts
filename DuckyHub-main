local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local scriptURL = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/Universal%20Tower.lua"
local keySaveFile = "DuckyHub_KeySave.json"

local keyURLs = {
    ["1 day"] = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/1day_key",
    ["3 day"] = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/3day_key",
    ["7 day"] = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/7day_key",
    ["Premium Trial"] = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/Premium_trial",
    ["Lifetime Premium"] = "https://raw.githubusercontent.com/DuckyZ11/DuckyZ11-scripts/refs/heads/main/Lifetime_Premium",
}

local durations = {
    ["1 day"] = 1,
    ["3 day"] = 3,
    ["7 day"] = 7,
    ["Premium Trial"] = 5,
    ["Lifetime Premium"] = 36500,
}

local allKeys = {}

local function fetchKeys()
    for keyType, url in pairs(keyURLs) do
        local success, data = pcall(function() return game:HttpGet(url) end)
        if success and data then
            for line in data:gmatch("[^\r\n]+") do
                allKeys[line] = keyType
            end
        end
    end
end

local function isKeyExpired(saved)
    if not saved or not saved.key or not saved.keyType or not saved.timestamp then return true end
    local now = os.time()
    local expireIn = durations[saved.keyType]
    return not expireIn or (now > (saved.timestamp + (expireIn * 86400)))
end

local function loadMainScript()
    loadstring(game:HttpGet(scriptURL))()
end

fetchKeys()

-- เช็คคีย์ที่เคยบันทึกไว้
local savedData = nil
if isfile and readfile and isfile(keySaveFile) then
    local success, result = pcall(function()
        return HttpService:JSONDecode(readfile(keySaveFile))
    end)
    if success then savedData = result end
end

if savedData and not isKeyExpired(savedData) then
    loadMainScript()
else
    -- GUI
    local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
    screenGui.Name = "KeyCheckGui"
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 350, 0, 160)
    frame.Position = UDim2.new(0.5, -175, 0.5, -80)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui

    local title = Instance.new("TextLabel", frame)
    title.Text = "Key Verification"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 22
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, 0, 0, 30)

    local keyBox = Instance.new("TextBox", frame)
    keyBox.PlaceholderText = "Enter your key here"
    keyBox.Font = Enum.Font.Gotham
    keyBox.TextSize = 18
    keyBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    keyBox.BackgroundColor3 = Color3.fromRGB(230, 230, 230)
    keyBox.Size = UDim2.new(0.9, 0, 0, 35)
    keyBox.Position = UDim2.new(0.05, 0, 0, 50)
    keyBox.ClearTextOnFocus = false

    local submitBtn = Instance.new("TextButton", frame)
    submitBtn.Text = "Submit"
    submitBtn.Font = Enum.Font.GothamSemibold
    submitBtn.TextSize = 18
    submitBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
    submitBtn.Size = UDim2.new(0.4, 0, 0, 40)
    submitBtn.Position = UDim2.new(0.05, 0, 0, 95)

    local getKeyBtn = Instance.new("TextButton", frame)
    getKeyBtn.Text = "Get Keys"
    getKeyBtn.Font = Enum.Font.GothamSemibold
    getKeyBtn.TextSize = 18
    getKeyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    getKeyBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 100)
    getKeyBtn.Size = UDim2.new(0.4, 0, 0, 40)
    getKeyBtn.Position = UDim2.new(0.55, 0, 0, 95)

    local statusLabel = Instance.new("TextLabel", frame)
    statusLabel.Text = ""
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextSize = 16
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Size = UDim2.new(1, 0, 0, 25)
    statusLabel.Position = UDim2.new(0, 0, 1, -25)

    submitBtn.MouseButton1Click:Connect(function()
        local key = keyBox.Text:match("^%s*(.-)%s*$")
        local keyType = allKeys[key]
        if keyType then
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            statusLabel.Text = "Key valid: " .. keyType
            wait(0.5)

            -- Save
            local data = {
                key = key,
                keyType = keyType,
                timestamp = os.time()
            }
            writefile(keySaveFile, HttpService:JSONEncode(data))

            screenGui:Destroy()
            loadMainScript()
        else
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            statusLabel.Text = "Invalid key, please try again."
        end
    end)

    getKeyBtn.MouseButton1Click:Connect(function()
        local link = "https://duckyz11.github.io/DuckyZ11-scripts/"
        if setclipboard then
            setclipboard(link)
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            statusLabel.Text = "Copied to clipboard!"
        else
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            statusLabel.Text = "Clipboard not supported."
        end
    end)
end
