local success, redzlib = pcall(function()
    return loadstring(game:HttpGet("https://gist.githubusercontent.com/MjContiga1/54c07e52fc2aab8873b68d91a71d11c6/raw/fb4f1d6a7c89465f3b39bc00eeff09af24b88f20/Redz%2520hub.lua"))()
end)
if not success then
    warn("Failed to load redzlib: " .. tostring(redzlib))
    return
end

-- Create window
local Window = redzlib:MakeWindow({
    Title = "Fisch Auto Reel",
    SubTitle = "Make For Lazy Fisher",
    SaveFolder = "FischSettings"
})

-- Check if the new image asset loads
local newImageId = "rbxassetid://135322148494327"
local fallbackImageId = "rbxassetid://139438145143663"
local imageId = newImageId
local success, err = pcall(function()
    game:GetService("ContentProvider"):PreloadAsync({newImageId})
end)
if not success then
    warn("Failed to load image " .. newImageId .. ": " .. tostring(err))
    imageId = fallbackImageId
end

-- Add minimize button (square with rounded corners)
Window:AddMinimizeButton({
    Button = { 
        Image = imageId, 
        BackgroundTransparency = 0,
        Size = UDim2.new(0, 44, 0, 44)
    },
    Corner = { CornerRadius = UDim.new(0, 8) }
})

-- Create single tab
local MainTab = Window:MakeTab({"Main", "rbxassetid://7733960981"})
Window:SelectTab(MainTab)

-- Add section
local Section = MainTab:AddSection({"Fisch Auto Reel"})

-- Initialize services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

-- Initialize settings
local SETTINGS_FILE = "Fischsv.json"
local Settings = {
    AutoReel = false,
    NormalMode = false,
    Smoothness = "Medium",
    AutoCast = false,
    CastMode = "Legit"
}

-- Load settings from file
if pcall(function() return readfile(SETTINGS_FILE) end) then
    local success, data = pcall(function()
        return HttpService:JSONDecode(readfile(SETTINGS_FILE))
    end)
    if success and data then
        for k, v in pairs(data) do
            Settings[k] = v
        end
    end
end

-- Variables
local autoreel = Settings.AutoReel
local normalmode = Settings.NormalMode
local smoothness = Settings.Smoothness
local autocast = Settings.AutoCast
local castmode = Settings.CastMode
local autoreel_running = false
local normalmode_running = false
local autocast_running = false

-- Save settings function
local function SaveSettings()
    pcall(function()
        local dataToSave = {}
        for k, v in pairs(Settings) do
            dataToSave[k] = v
        end
        writefile(SETTINGS_FILE, HttpService:JSONEncode(dataToSave))
    end)
end

-- Get HumanoidRootPart
local function GetHumanoidRootPart()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

-- Linear interpolation for smooth movement
local function lerp(a, b, t)
    return a + (b - a) * t
end

-- Get smoothness value (faster tracking for Auto Reel Normal)
local function getSmoothnessValue(isNormalMode)
    if isNormalMode then
        if smoothness == "Slow" then
            return 0.25
        elseif smoothness == "Fast" then
            return 0.8
        else -- Medium
            return 0.4
        end
    else
        if smoothness == "Slow" then
            return 0.15
        elseif smoothness == "Fast" then
            return 0.25
        else -- Medium
            return 0.2
        end
    end
end

-- Auto Reel (Legit mode, continuous tracking)
local function StartAutoReel()
    if autoreel_running or normalmode_running then return end
    autoreel_running = true
    task.defer(function()
        while autoreel do
            local gui = player:FindFirstChild("PlayerGui")
            local reel = gui and gui:FindFirstChild("reel")
            while autoreel and gui and not reel do
                reel = gui:FindFirstChild("reel")
                task.wait(0.1)
            end
            if reel then
                local char = player.Character
                if char then
                    for _, tool in ipairs(char:GetChildren()) do
                        if tool:IsA("Tool") then
                            while autoreel and reel and reel.Parent and tool.Parent == char do
                                local success, err = pcall(function()
                                    local bar = reel:FindFirstChild("bar")
                                    local fish = bar and bar:FindFirstChild("fish")
                                    local playerbar = bar and bar:FindFirstChild("playerbar")
                                    if fish and playerbar then
                                        local currentX = playerbar.Position.X.Scale
                                        local currentY = playerbar.Position.Y.Scale
                                        local lerpT = getSmoothnessValue(false)
                                        while autoreel and reel and reel.Parent and fish and playerbar and tool.Parent == char do
                                            local targetX = fish.Position.X.Scale + math.random(-0.005, 0.005)
                                            local targetY = fish.Position.Y.Scale + math.random(-0.005, 0.005)
                                            currentX = lerp(currentX, targetX, lerpT)
                                            currentY = lerp(currentY, targetY, lerpT)
                                            playerbar.Position = UDim2.new(currentX, 0, currentY, 0)
                                            task.wait(0.01)
                                            bar = reel:FindFirstChild("bar")
                                            fish = bar and bar:FindFirstChild("fish")
                                            playerbar = bar and bar:FindFirstChild("playerbar")
                                        end
                                    else
                                        warn("Reel UI elements not found")
                                    end
                                end)
                                if not success then
                                    warn("Error in AutoReel: " .. err)
                                    autoreel = false
                                    Settings.AutoReel = false
                                    SaveSettings()
                                    return
                                end
                                task.wait(0.1)
                            end
                        end
                    end
                end
            else
                warn("Reel UI not found")
            end
            task.wait(0.1)
        end
        autoreel_running = false
    end)
end

-- Auto Reel Normal (continuous tracking)
local function StartAutoReelNormal()
    if normalmode_running or autoreel_running then return end
    normalmode_running = true
    task.defer(function()
        while normalmode do
            local gui = player:FindFirstChild("PlayerGui")
            local reel = gui and gui:FindFirstChild("reel")
            while normalmode and gui and not reel do
                reel = gui:FindFirstChild("reel")
                task.wait(0.1)
            end
            if reel then
                local char = player.Character
                if char then
                    for _, tool in ipairs(char:GetChildren()) do
                        if tool:IsA("Tool") then
                            while normalmode and reel and reel.Parent and tool.Parent == char do
                                local success, err = pcall(function()
                                    local bar = reel:FindFirstChild("bar")
                                    local fish = bar and bar:FindFirstChild("fish")
                                    local playerbar = bar and bar:FindFirstChild("playerbar")
                                    if fish and playerbar then
                                        local currentX = playerbar.Position.X.Scale
                                        local currentY = playerbar.Position.Y.Scale
                                        local lerpT = getSmoothnessValue(true)
                                        while normalmode and reel and reel.Parent and fish and playerbar and tool.Parent == char do
                                            local targetX = fish.Position.X.Scale + math.random(-0.01, 0.01)
                                            local targetY = fish.Position.Y.Scale + math.random(-0.01, 0.01)
                                            currentX = lerp(currentX, targetX, lerpT)
                                            currentY = lerp(currentY, targetY, lerpT)
                                            playerbar.Position = UDim2.new(currentX, 0, currentY, 0)
                                            task.wait(0.01)
                                            bar = reel:FindFirstChild("bar")
                                            fish = bar and bar:FindFirstChild("fish")
                                            playerbar = bar and bar:FindFirstChild("playerbar")
                                        end
                                    else
                                        warn("Reel UI elements not found")
                                    end
                                end)
                                if not success then
                                    warn("Error in AutoReelNormal: " .. err)
                                    normalmode = false
                                    Settings.NormalMode = false
                                    SaveSettings()
                                    return
                                end
                                task.wait(0.1)
                            end
                        end
                    end
                end
            else
                warn("Reel UI not found")
            end
            task.wait(0.1)
        end
        normalmode_running = false
    end)
end

-- Auto Cast
local function StartAutoCast()
    if autocast_running then return end
    autocast_running = true
    task.spawn(function()
        while autocast do
            local success, err = pcall(function()
                local LocalCharacter = player.Character
                if LocalCharacter then
                    local tool = LocalCharacter:FindFirstChildOfClass("Tool")
                    if tool then
                        local hasBobber = tool:FindFirstChild("bobber")
                        if not hasBobber then
                            if castmode == "Legit" then
                                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, player, 0)
                                local HumanoidRootPart = GetHumanoidRootPart()
                                local connection
                                connection = HumanoidRootPart.ChildAdded:Connect(function()
                                    if HumanoidRootPart:FindFirstChild("power") and HumanoidRootPart.power:FindFirstChild("powerbar") and HumanoidRootPart.power.powerbar:FindFirstChild("bar") then
                                        local barConnection
                                        barConnection = HumanoidRootPart.power.powerbar.bar.Changed:Connect(function(property)
                                            if property == "Size" then
                                                if HumanoidRootPart.power.powerbar.bar.Size == UDim2.new(1, 0, 1, 0) then
                                                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, player, 0)
                                                    if barConnection then barConnection:Disconnect() end
                                                end
                                            end
                                        end)
                                    end
                                end)
                                task.spawn(function()
                                    task.wait(5)
                                    if connection then connection:Disconnect() end
                                end)
                            elseif castmode == "Blatant" then
                                local rod = LocalCharacter:FindFirstChildOfClass("Tool")
                                if rod and rod:FindFirstChild("values") and string.find(rod.Name, "Rod") then
                                    local Random = math.random(90, 99)
                                    rod.events.cast:FireServer(Random)
                                end
                            end
                        end
                    end
                end
            end)
            if not success then
                warn("Error in AutoCast: " .. err)
                autocast = false
                Settings.AutoCast = false
                SaveSettings()
                autocast_running = false
                return
            end
            task.wait(0.5)
        end
        autocast_running = false
    end)
end

-- Auto Reel Toggle (Legit mode)
MainTab:AddToggle({
    Name = "Auto Reel (Legit)",
    Flag = "AutoReel",
    Default = autoreel,
    Callback = function(state)
        autoreel = state
        Settings.AutoReel = state
        if state and normalmode then
            normalmode = false
            Settings.NormalMode = false
            normalmode_running = false
        end
        SaveSettings()
        if state then
            local success, err = pcall(StartAutoReel)
            if not success then
                warn("Error in StartAutoReel: " .. err)
                autoreel = false
                Settings.AutoReel = false
                SaveSettings()
            end
        else
            autoreel_running = false
        end
    end
})

-- Auto Reel Normal Toggle
MainTab:AddToggle({
    Name = "Auto Reel (Normal)",
    Flag = "NormalMode",
    Default = normalmode,
    Callback = function(state)
        normalmode = state
        Settings.NormalMode = state
        if state and autoreel then
            autoreel = false
            Settings.AutoReel = false
            autoreel_running = false
        end
        SaveSettings()
        if state then
            local success, err = pcall(StartAutoReelNormal)
            if not success then
                warn("Error in StartAutoReelNormal: " .. err)
                normalmode = false
                Settings.NormalMode = false
                SaveSettings()
            end
        else
            normalmode_running = false
        end
    end
})

-- Auto Cast Toggle
MainTab:AddToggle({
    Name = "Auto Cast",
    Flag = "AutoCast",
    Default = autocast,
    Callback = function(state)
        autocast = state
        Settings.AutoCast = state
        SaveSettings()
        if state then
            local success, err = pcall(StartAutoCast)
            if not success then
                warn("Error in StartAutoCast: " .. err)
                autocast = false
                Settings.AutoCast = false
                SaveSettings()
            end
        else
            autocast_running = false
        end
    end
})

-- Cast Mode Dropdown
MainTab:AddDropdown({
    Name = "Cast Mode",
    Options = {"Legit", "Blatant"},
    Default = Settings.CastMode or "Legit",
    Callback = function(choice)
        castmode = choice
        Settings.CastMode = choice
        SaveSettings()
        if autocast then
            autocast_running = false
            local success, err = pcall(StartAutoCast)
            if not success then
                warn("Error restarting AutoCast: " .. err)
                autocast = false
                Settings.AutoCast = false
                SaveSettings()
            end
        end
    end
})

-- Smoothness Dropdown
MainTab:AddDropdown({
    Name = "Smoothness",
    Options = {"Slow", "Medium", "Fast"},
    Default = Settings.Smoothness or "Medium",
    Callback = function(choice)
        smoothness = choice
        Settings.Smoothness = choice
        SaveSettings()
        if autoreel or normalmode then
            autoreel_running = false
            normalmode_running = false
            local success, err
            if autoreel then
                success, err = pcall(StartAutoReel)
            elseif normalmode then
                success, err = pcall(StartAutoReelNormal)
            end
            if not success then
                warn("Error restarting AutoReel: " .. err)
                autoreel = false
                normalmode = false
                Settings.AutoReel = false
                Settings.NormalMode = false
                SaveSettings()
            end
        end
    end
})

-- Instant Reel Button
MainTab:AddButton({
    Name = "Instant Reel",
    Callback = function()
        local args = {
            [1] = 100,
            [2] = false
        }
        print("Firing reelfinished with args:", args[1], args[2])
        game:GetService("ReplicatedStorage").events.reelfinished:FireServer(unpack(args))
    end
})
